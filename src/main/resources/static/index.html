<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Test</title>
</head>

<body>
    <h1>WebRTC Test</h1>
    <button onclick="startCall()">Start Call</button>
    <button onclick="endCall()">End Call</button>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <div id="videoContainer"></div>

    <script>
        let socket;
        let localStream;
        const peerConnections = {};
        const processedStreams = new Set();
        const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const localVideo = document.getElementById('localVideo');
        const videoContainer = document.getElementById('videoContainer');
        let sessionId;

        function startCall() {
            socket = new WebSocket('ws://localhost:8080/signal');
            socket.onopen = handleSocketOpen;
            socket.onmessage = handleSocketMessage;
            socket.onclose = handleSocketClose;
            socket.onerror = handleSocketError;
        }

        function handleSocketOpen() {
            console.log("WebSocket 연결");
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    console.log("LocalStream 설정");
                    localStream = stream;
                    localVideo.srcObject = localStream;
                    socket.send(JSON.stringify({ join: sessionId }));
                })
                .catch(error => console.error("Media Device 연결 오류: ", error));
        }

        function handleSocketMessage(event) {
            const message = JSON.parse(event.data);
            if (message.sessionId) {
                sessionId = message.sessionId;
            } else if (message.join) {
                handleJoin(message.join);
            } else if (message.offer) {
                handleOffer(message.offer, message.from, message.to);
            } else if (message.answer) {
                handleAnswer(message.answer, message.from, message.to);
            } else if (message.iceCandidate) {
                handleNewICECandidate(message.iceCandidate, message.from, message.to);
            } else if (message.leave) {
                handleLeave(message.leave);
            }
        }

        function handleSocketClose() {
            console.log("WebSocket 연결 끊김");
        }

        function handleSocketError(error) {
            console.error("WebSocket 오류: ", error);
        }

        function endCall() {
            Object.values(peerConnections).forEach(pc => pc.close());
            Object.keys(peerConnections).forEach(key => delete peerConnections[key]);

            const remoteVideos = videoContainer.querySelectorAll('video');
            remoteVideos.forEach(video => video.remove());

            if (socket) {
                socket.send(JSON.stringify({ leave: sessionId }));
                socket.close();
            }

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            localVideo.srcObject = null;

            sessionId = null;

            processedStreams.clear();
        }

        function makePeerConnection(id) {
            console.log("PeerConnection 생성. from:", id);
            const peerConnection = new RTCPeerConnection(configuration);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log("ICE 후보 정보 전송");
                    socket.send(JSON.stringify({ iceCandidate: event.candidate, from: sessionId, to: id }));
                }
            };

            peerConnection.ontrack = event => {
                if (processedStreams.has(event.streams[0].id)) return;
                processedStreams.add(event.streams[0].id);
                const remoteVideo = document.createElement('video');
                remoteVideo.id = `remoteVideo_${id}`;
                remoteVideo.autoplay = true;
                videoContainer.append(remoteVideo);
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    console.log(`PeerConnection ${id} 연결`);
                }
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnections[id] = peerConnection;
            return peerConnection;
        }

        function handleJoin(id) {
            console.log("Offer 생성 및 LocalDescription 설정:", id);
            const peerConnection = makePeerConnection(id);
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => socket.send(JSON.stringify({ offer: peerConnection.localDescription, from: sessionId, to: id })))
                .catch(error => console.error("Offer 생성 오류: ", error));
        }

        function handleOffer(offer, from, to) {
            if (to !== sessionId) return;
            console.log("Offer 수신. from :", from, " to:", to);
            const peerConnection = makePeerConnection(from);
            peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => peerConnection.createAnswer())
                .then(answer => peerConnection.setLocalDescription(answer))
                .then(() => socket.send(JSON.stringify({ answer: peerConnection.localDescription, from: sessionId, to: from })))
                .catch(error => console.error("Offer 핸들링 오류: ", error));
        }

        function handleAnswer(answer, from, to) {
            if (to !== sessionId) return;
            console.log("Answer 수신. from :", from, " to:", to);
            const peerConnection = peerConnections[from];
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                .catch(error => console.error("RemoteDescription 오류: ", error));
        }

        function handleNewICECandidate(candidate, from, to) {
            if (to !== sessionId) return;
            console.log("IceCandidate 수신. from :", from, " to:", to);
            const peerConnection = peerConnections[from];
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
                .catch(error => console.error("ICE 후보 추가 오류: ", error));
        }

        function handleLeave(id) {
            const peerConnection = peerConnections[id];
            if (peerConnection) {
                console.log("RemoteVideo 종료: ", id);
                peerConnection.close();
                delete peerConnections[id];

                const remoteVideo = document.getElementById(`remoteVideo_${id}`);
                if (remoteVideo) {
                    remoteVideo.srcObject = null;
                    remoteVideo.parentNode.removeChild(remoteVideo);
                }

                processedStreams.delete(id);
            }
        }

    </script>
</body>

</html>